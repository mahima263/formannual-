<script>
    // Payment Partner Links
    const paymentLinks = {
        'usa': 'https://www.zeffy.com/en-US/donation-form/bb809edf-3a48-4fec-931b-18fcbee7da40',
        'uk': 'https://donate.justgiving.com/charity/eff-iitkanpur/donation-amount',
        'australia': 'https://myriadau.fcsuite.com/erp/donate/create/fund?funit_id=1128',
        'canada': 'https://www.canadahelps.org/en/charities/myriad-canada/campaign/h502-support-education-research-and-access-to-healthcare-with-the-iit-kanpur/#create-a-campaign',
        'germany': 'https://donate.transnationalgiving.eu/germany/IITKanpur',
        'belgium': 'https://donate.kbs-frb.be/actions/EFF-IITKanpurUniversity'
    };

    // Payment Modal Functions
    function openPaymentModal(country, countryName, donationType) {
        const modal = document.getElementById('paymentModal');
        const modalTitle = document.getElementById('modalCountryTitle');
        const modalContent = document.getElementById('modalContent');
        const proceedButton = document.getElementById('proceedButton');

        let content = '';
        let paymentLink = paymentLinks[country] || '#';
        
        // Add donation type to the title if it's monthly
        const titlePrefix = donationType === 'monthly' ? 'Monthly ' : '';
        
        switch (country) {
            case 'usa':
                modalTitle.innerHTML = `ðŸ‡ºðŸ‡¸ United States ${titlePrefix}Payment Instructions`;
                content = `<div class="payment-steps"><h4>Steps:</h4><ol><li>Enter amount: $15 / $30 / $60 / $120.</li><li>Enter your details and Complete Payment</li></ol></div>`;
                break;
            case 'uk':
                modalTitle.innerHTML = `ðŸ‡¬ðŸ‡§ United Kingdom ${titlePrefix}Payment Instructions`;
                content = `<div class="payment-steps"><h4>Steps:</h4><ol><li>${donationType === 'monthly' ? 'Select "Monthly" Option' : 'Select Donation Type'}</li><li>Enter amount: Â£30 / Â£50 / Â£150 / Â£200.</li><li>Enter your details and Complete Payment</li></ol></div>`;
                break;
            case 'australia':
                modalTitle.innerHTML = `ðŸ‡¦ðŸ‡º Australia ${titlePrefix}Payment Instructions`;
                content = `<div class="payment-steps"><h4>Steps:</h4><ol><li>${donationType === 'monthly' ? 'Select "Recurring Donation Amount"' : 'Select Donation Type'}</li><li>Enter amount${donationType === 'monthly' ? ' and End date' : ''}.</li><li>Enter your details and Complete Payment</li></ol></div>`;
                break;
            case 'canada':
                modalTitle.innerHTML = `ðŸ‡¨ðŸ‡¦ Canada ${titlePrefix}Payment Instructions`;
                content = `<div class="payment-steps"><h4>Steps:</h4><ol><li>${donationType === 'monthly' ? 'Select "Donate Monthly"' : 'Select Donation Type'}</li><li>Enter amount</li><li>Enter your details and Complete Payment</li></ol></div>`;
                break;
            case 'germany':
                modalTitle.innerHTML = `ðŸ‡©ðŸ‡ª Germany ${titlePrefix}Payment Instructions`;
                content = `<div class="payment-steps"><h4>Steps:</h4><ol><li>${donationType === 'monthly' ? 'Select "Donate every month"' : 'Select Donation Type'}</li><li>Enter amount: â‚¬50 / â‚¬80 / â‚¬100 / â‚¬250.</li><li>Enter your details and Complete Payment</li></ol></div>`;
                break;
            case 'belgium':
                modalTitle.innerHTML = `ðŸ‡§ðŸ‡ª Belgium ${titlePrefix}Payment Instructions`;
                content = `<div class="payment-steps"><h4>Steps:</h4><ol><li>${donationType === 'monthly' ? 'Select "Don Mensuel/ I Donate every month"' : 'Select Donation Type'}</li><li>Enter Amount</li><li>Enter your details and Complete Payment</li></ol></div>`;
                break;
            default: return;
        }

        modalContent.innerHTML = content;
        proceedButton.href = paymentLink;
        modal.style.display = 'flex';
    }

    function closePaymentModal() {
        document.getElementById('paymentModal').style.display = 'none';
    }

    window.onclick = function (event) {
        const modal = document.getElementById('paymentModal');
        if (event.target == modal) closePaymentModal();
    }

    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') closePaymentModal();
    });

    // Tab switching function
    function switchTab(step) {
        document.querySelectorAll('.form-step').forEach(stepDiv => stepDiv.classList.remove('active'));
        document.getElementById('step' + step).classList.add('active');

        if (step === 2) updateStep2DonationDisplay();
    }

    // Function to update donation display in step 2
    function updateStep2DonationDisplay() {
        const selectedAmount = getSelectedAmount();
        const selectedType = getSelectedType();

        if (selectedAmount) {
            document.getElementById('step2AmountDisplay').textContent = 'â‚¹' + selectedAmount;
            document.getElementById('step2TypeDisplay').textContent = selectedType === 'monthly' ? 'Monthly' : 'One-time';
        }
    }

    // Function to get selected amount
    function getSelectedAmount() {
        const selectedOption = document.querySelector('.amount-option.selected');
        if (selectedOption) return selectedOption.getAttribute('data-amount');

        const isMonthly = getSelectedType() === 'monthly';
        const customAmount = isMonthly ?
            document.getElementById('monthly-customAmountInput').value :
            document.getElementById('onetime-customAmountInput').value;
        const otherBox = isMonthly ?
            document.getElementById('monthly-other-option-box') :
            document.getElementById('onetime-other-option-box');

        if (customAmount && otherBox.classList.contains('selected')) return customAmount;

        return null;
    }

    // Function to get selected type
    function getSelectedType() {
        const activeOption = document.querySelector('.donation-type-option.active');
        return activeOption ? activeOption.getAttribute('data-type') : 'one-time';
    }

    // Function to update donation display
    function updateDonationDisplay() {
        const selectedAmount = getSelectedAmount();
        const selectedType = getSelectedType();
        const displayElement = document.getElementById('selectedDonationDisplay');

        if (selectedAmount) {
            document.getElementById('selectedAmountDisplay').textContent = 'â‚¹' + selectedAmount;
            document.getElementById('selectedTypeDisplay').textContent = selectedType === 'monthly' ? 'Monthly' : 'One-time';
            displayElement.classList.add('show');
        } else {
            displayElement.classList.remove('show');
        }
    }

    // Function to switch amount options based on donation type
    function switchAmountOptions(donationType) {
        const monthlyAmounts = document.getElementById('monthly-amounts');
        const onetimeAmounts = document.getElementById('onetime-amounts');

        if (donationType === 'monthly') {
            monthlyAmounts.style.display = 'flex';
            onetimeAmounts.style.display = 'none';
        } else {
            monthlyAmounts.style.display = 'none';
            onetimeAmounts.style.display = 'flex';
        }

        // Clear selections
        document.querySelectorAll('.amount-option').forEach(opt => opt.classList.remove('selected'));
        document.querySelectorAll('.other-option-box').forEach(box => {
            box.classList.remove('selected');
            const input = box.querySelector('input');
            if (input) input.value = '';
        });

        updateDonationDisplay();
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function () {
        // Country selection logic
        const countryDropdown = document.querySelector('.country-dropdown');
        const countrySelected = countryDropdown.querySelector('.dropdown-selected');
        const countryOptions = countryDropdown.querySelectorAll('.option');
        const indiaContent = document.getElementById('india-content');
        const otherCountryContent = document.getElementById('other-country-content');
        const globalNote = document.getElementById('global-note');
        const nextButton = document.getElementById('nextButton');

        let selectedCountry = 'india'; // Default to India

        countrySelected.addEventListener('click', function () {
            countryDropdown.classList.toggle('active');
        });

        countryOptions.forEach(option => {
            option.addEventListener('click', function () {
                const value = this.getAttribute('data-value');
                const text = this.textContent;

                countrySelected.textContent = text;
                countrySelected.setAttribute('data-value', value);
                countryDropdown.classList.remove('active');
                
                // Store selected country
                selectedCountry = value;
                
                // Show/hide content based on country selection
                if (value === 'india') {
                    indiaContent.style.display = 'block';
                    otherCountryContent.style.display = 'none';
                    globalNote.style.display = 'block';
                    nextButton.textContent = 'Next â†’';
                    nextButton.style.display = 'block';
                } else {
                    indiaContent.style.display = 'none';
                    otherCountryContent.style.display = 'block';
                    globalNote.style.display = 'none';
                    nextButton.textContent = 'Proceed to Payment';
                    nextButton.style.display = 'block';
                }
            });
        });

        // Donation type toggle
        const donationTypeOptions = document.querySelectorAll('.donation-type-option');
        donationTypeOptions.forEach(option => {
            option.addEventListener('click', function () {
                donationTypeOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                switchAmountOptions(this.getAttribute('data-type'));
            });
        });

        // Initialize amount selection for both types
        function initializeAmountSelection(amountContainerId, otherBoxId, customInputId) {
            const amountContainer = document.getElementById(amountContainerId);
            if (!amountContainer) return;

            const amountOptions = amountContainer.querySelectorAll('.amount-option');
            const otherOptionBox = document.getElementById(otherBoxId);
            const customAmountInput = document.getElementById(customInputId);

            amountOptions.forEach(option => {
                option.addEventListener('click', function () {
                    amountOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    otherOptionBox.classList.remove('selected');
                    customAmountInput.value = '';
                    updateDonationDisplay();
                });
            });

            otherOptionBox.addEventListener('click', function () {
                amountOptions.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                customAmountInput.focus();
                updateDonationDisplay();
            });

            customAmountInput.addEventListener('input', function () {
                if (this.value) {
                    amountOptions.forEach(opt => opt.classList.remove('selected'));
                    otherOptionBox.classList.add('selected');
                    updateDonationDisplay();
                } else if (otherOptionBox.classList.contains('selected')) {
                    document.getElementById('selectedDonationDisplay').classList.remove('show');
                }
            });
        }

        // Initialize both sets of amount options
        initializeAmountSelection('monthly-amounts', 'monthly-other-option-box', 'monthly-customAmountInput');
        initializeAmountSelection('onetime-amounts', 'onetime-other-option-box', 'onetime-customAmountInput');

        // Next button functionality - UPDATED LOGIC
        nextButton.addEventListener('click', function (e) {
            e.preventDefault();

            // Check if country is selected
            if (!selectedCountry) {
                alert('Please select your country');
                return;
            }

            if (selectedCountry === 'india') {
                // For India: validate amount and go to step 2
                const selectedAmount = getSelectedAmount();
                if (!selectedAmount) {
                    alert('Please select or enter a donation amount');
                    return;
                }
                
                updateStep2DonationDisplay();
                switchTab(2);
            } else {
                // For other countries: check the selected donation type
                const selectedType = getSelectedType();
                const countryName = document.querySelector('.country-dropdown .dropdown-selected').textContent;

                if (selectedType === 'monthly') {
                    // Open modal for monthly donation
                    openPaymentModal(selectedCountry, countryName, 'monthly');
                } else {
                    // For one-time donation, directly open the payment link
                    if (paymentLinks[selectedCountry]) {
                        window.open(paymentLinks[selectedCountry], '_blank');
                    } else {
                        alert('Payment link not available for this country.');
                    }
                }
            }
        });

        // Form submission handling (India only)
        document.getElementById('donationForm').addEventListener('submit', function (e) {
            e.preventDefault();
            
            // Only allow form submission for India
            if (selectedCountry !== 'india') {
                alert('Please use the payment options for your country from the previous step.');
                return;
            }

            // Collect form data
            const formData = new FormData(this);

            // Get donation amount
            let donationAmount = getSelectedAmount();
            if (!donationAmount) {
                alert('Please select a donation amount');
                return;
            }

            // Add donation data
            formData.append('amount', donationAmount);
            formData.append('type', getSelectedType());

            // Here you would typically submit to your backend
            console.log('Form data:', Object.fromEntries(formData));

            alert('Proceeding with Indian payment gateway...');
            // In real implementation, submit form to server
        });

        // Initialize Year of Graduation dropdown
        const yogDropdown = document.querySelector('.yog-dropdown');
        if (yogDropdown) {
            const yogOptions = document.getElementById('yog-options');
            const yogSelected = yogDropdown.querySelector('.dropdown-selected');

            // Generate years from 1965 to current year
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= 1965; year--) {
                const option = document.createElement('div');
                option.className = 'option';
                option.textContent = year;
                option.setAttribute('data-value', year);
                yogOptions.appendChild(option);
            }

            // Toggle yog dropdown
            yogSelected.addEventListener('click', function () {
                yogDropdown.classList.toggle('active');
            });

            // Select yog option
            yogOptions.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function () {
                    yogSelected.textContent = this.textContent;
                    yogSelected.setAttribute('data-value', this.getAttribute('data-value'));
                    yogDropdown.classList.remove('active');
                });
            });
        }

        // Affiliation dropdown functionality
        const affiliationDropdown = document.querySelector('.affiliation-dropdown');
        if (affiliationDropdown) {
            const affiliationSelected = affiliationDropdown.querySelector('.dropdown-selected');
            const alumniFields = document.getElementById('alumniFields');

            affiliationSelected.addEventListener('click', function () {
                affiliationDropdown.classList.toggle('active');
            });

            affiliationDropdown.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function () {
                    affiliationSelected.textContent = this.textContent;
                    affiliationSelected.setAttribute('data-value', this.getAttribute('data-value'));
                    affiliationDropdown.classList.remove('active');

                    // Show/hide alumni fields
                    if (this.getAttribute('data-value') === 'alumni') {
                        alumniFields.style.display = 'block';
                    } else {
                        alumniFields.style.display = 'none';
                    }
                });
            });
        }

        // Other dropdown functionalities
        const otherDropdowns = document.querySelectorAll('.dropdown:not(.country-dropdown):not(.yog-dropdown):not(.affiliation-dropdown)');
        otherDropdowns.forEach(dropdown => {
            const selected = dropdown.querySelector('.dropdown-selected');
            const options = dropdown.querySelector('.dropdown-options');

            if (selected && options) {
                selected.addEventListener('click', function () {
                    dropdown.classList.toggle('active');
                });

                options.querySelectorAll('.option').forEach(option => {
                    option.addEventListener('click', function () {
                        selected.textContent = this.textContent;
                        selected.setAttribute('data-value', this.getAttribute('data-value') || this.textContent);
                        dropdown.classList.remove('active');
                    });
                });
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown').forEach(dropdown => {
                    dropdown.classList.remove('active');
                });
            }
        });
    });
</script>